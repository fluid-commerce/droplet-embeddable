import{D as e,M as n}from"./p-D-AfQOnq.js";const t="en-US",o=(e,{mapFn:n=e=>e,filterFn:t=Boolean})=>{if(!e)return;const o=e.filter(t);if(o.length!==0)return o.map(n)},r=e=>e.name,i=e=>!!(e&&e.dimension&&(e.granularity||e.dateRange)),a=(e,n,t,o)=>{const r=[],i=[...[...t,...n].filter(Boolean).map((e=>e.name)),...o.filter(Boolean).map((e=>e.dimension)).filter(Boolean)];for(const n of e){const{name:e}=n.property;i.includes(e)||r.push(e)}return r},l=(e,n={})=>({__embeddableType:"built-in",toString:()=>e,typeConfig:{label:e,optionLabel:()=>e,...n}}),s=e=>{if(!e.property)return"filter property must be set";if(!e.operator)return"filter operator must be set"},u=e=>{if(e==null||typeof e=="string"||typeof e=="boolean"||typeof e=="number"||e instanceof Date||Array.isArray(e))return e;if(e!=null&&e.relativeTimeString)return e==null?void 0:e.relativeTimeString;if(Object.hasOwn(e,"date"))return e==null?void 0:e.date;if(Object.hasOwn(e,"from")||Object.hasOwn(e,"to")){const n=e;return[n==null?void 0:n.from,n==null?void 0:n.to].filter(Boolean)}};function d(e){if(!e||e.length===0)return[];const n=new Set;return e.filter((e=>n.has(e.name)?false:(n.add(e.name),true)))}const m="dimension",c="measure",p=e=>Array.isArray(e)?e.flatMap(p):[e],f=e=>{var n;const t={dimensions:[],measures:[],timeDimensions:[]};if(!e)return t;const o=p(e).filter(Boolean);if(!o.length)return t.error="select must not be empty",t;for(const e of o){if(!(typeof e=="object"&&($(e)||A(e))))return t.error="select must only contain Dimension, Measure or TimeDimension objects",t;if(A(e))t.timeDimensions.push(e);else if(L(e)){const o=e,r=(n=o.inputs)==null?void 0:n.granularity;o.nativeType==="time"&&r?t.timeDimensions.push({dimension:o.name,granularity:r,title:o.title}):t.dimensions.push(o)}else if(T(e))t.measures.push(e);else{const n="__type__"in e?e.__type__:typeof e;return t.error=`Unknown __type__ in select: ${n}`,t}}return t};function v(e){var n,t;return((n=e.measures)==null?void 0:n.length)>0&&e.measures.some((e=>(e==null?void 0:e.__type__)!==c))?"Unexpected type passed to `measures` in loadData function.  Expected an array of type Measure.":((t=e.dimensions)==null?void 0:t.length)>0&&e.dimensions.some((e=>(e==null?void 0:e.__type__)!==m))?"Unexpected type passed to `dimensions` in loadData function.  Expected an array of type Dimension.":null}function b(e){const n={dimensions:[],measures:[],timeDimensions:[],usingSelect:false};if(e.select){n.usingSelect=true;const t=f(e.select);if(t.error)return n.error=t.error,n;n.dimensions=t.dimensions,n.measures=t.measures,n.timeDimensions=t.timeDimensions}else{const t=v(e);if(t)return n.error=t,n;n.dimensions=o(e.dimensions,{mapFn:e=>e})??[],n.measures=o(e.measures,{mapFn:e=>e})??[],n.timeDimensions=o(e.timeDimensions,{filterFn:Boolean})??[]}return n.dimensions=d(n.dimensions),n.measures=d(n.measures),n}function y(e,n,t,o){const r=a(e??[],n,t,o);return r.length>0?`Cannot order by ${r.join(", ")} as no such ${r.length===1?"property":"properties"} has been loaded.`:null}function g(e){if(e){const n=e.map(((e,n)=>({index:n,message:s(e)}))).filter((e=>!!e.message));if(n.length)return n.map((e=>`filter[${e.index}] is not valid: ${e.message}`)).join(`\n`)}return null}function w(e,n,t,a,l){var s;return{inputName:e.from.inputName,datasetId:e.from.datasetId,embeddableId:e.from.embeddableId,dimensions:o(n,{mapFn:r})??[],measures:o(t,{mapFn:r})??[],order:l,timeDimensions:o(a,{filterFn:i})??[],offset:e.offset,limit:e.limit,variableValues:e.from.variableValues,filters:(s=e.filters)==null?void 0:s.map((e=>({member:e.property.name,operator:e.operator,values:u(e.value)})))}}const D="embeddable-event:load-data",_=e=>typeof e=="object"&&e&&"requestParams"in e&&"dataLoader"in e,O=(e,n,t,r)=>{if(!n.from)return"No dataset selected";if(n.select&&(n.dimensions||n.measures||n.timeDimensions))return"loadData expects you to use either dimensions, timeDimensions and measures, or select. You cannot use both together.";const i=b(n);if(i.error)return i.error;const{dimensions:a,measures:l,timeDimensions:s}=i;if(!(a.length||l.length||s.length))return"At least a dimension or a measure should be selected.";const u=y(n.orderBy,a,l,s);if(u)return u;const d=g(n.filters);if(d)return d;const m=o(n.orderBy,{mapFn:e=>[e.property.name,e.direction]}),c=w(n,a,l,s,m);e.dispatchEvent(new CustomEvent(D,{bubbles:true,composed:true,detail:{query:c,componentId:t,propertyName:r}}))},j=e=>({requestParams:e,dataLoader:O}),L=e=>(e==null?void 0:e.__type__)===m,T=e=>(e==null?void 0:e.__type__)===c,A=e=>"dimension"in(e??{})&&!("__type__"in e),$=e=>L(e)||T(e),x=(e,n)=>({operation:e,value:n??null,__embeddableVariableMeta:true}),N={noFilter:()=>x("NO_FILTER"),of:e=>x("VALUE",e)},F="embeddable:value:changed",I=(e,n,t,o)=>{const r=new CustomEvent(F,{bubbles:true,composed:true,detail:{componentId:t,value:n,eventName:o}});e.dispatchEvent(r)},h=l("string",{transform:e=>e,optionLabel:e=>Array.isArray(e)?`[${e.map((e=>`"${e}"`)).join(",")}]`:`"${e}"`}),B=l("number",{transform:e=>Array.isArray(e)?e:e&&Number(e),optionLabel:e=>Array.isArray(e)?`[${e.join(",")}]`:(e==null?void 0:e.toLocaleString(t))??""}),S=l("boolean",{transform:e=>e==="true"||e===true,optionLabel:e=>e?"true":"false"}),E=l("time",{transform:e=>{const n=e!=null&&e.date?new Date(e.date):void 0;return{date:n&&n.toString()!=="Invalid Date"?n:void 0,relativeTimeString:e==null?void 0:e.relativeTimeString}},optionLabel:e=>{var n;return e?e!=null&&e.date?((n=e.date)==null?void 0:n.toLocaleDateString(t))??e.date.toLocaleString():e.relativeTimeString:""}}),C=l("timeRange",{transform:e=>{if(!e)return;const[n,t]=[e==null?void 0:e.from,e==null?void 0:e.to],o=new Date(n),r=new Date(t);return{from:o.toString()!=="Invalid Date"?o:void 0,to:r.toString()!=="Invalid Date"?r:void 0,relativeTimeString:e==null?void 0:e.relativeTimeString}},optionLabel:e=>{var n,o,r,i;return e?e!=null&&e.from&&(e!=null&&e.to)?`${((n=e.from)==null?void 0:n.toLocaleDateString(t))??((o=e.from)==null?void 0:o.toLocaleString())},${((r=e.to)==null?void 0:r.toLocaleDateString(t))??((i=e.to)==null?void 0:i.toLocaleString())}`:e==null?void 0:e.relativeTimeString:""}}),U=l("granularity",{transform:e=>e,optionLabel:e=>e}),M=l("dataset"),P=l("measure"),q=l("dimension"),R=l("dimensionOrMeasure");var V=Object.freeze({__proto__:null,BooleanType:S,DatasetType:M,DimensionOrMeasureType:R,DimensionType:q,GranularityType:U,MeasureType:P,NumberType:B,StringType:h,TimeRangeType:C,TimeType:E});const k=n.createContext({}),G=(e={})=>{const t=n.useContext(k);return n.useEffect((()=>{Array.isArray(t)&&typeof t[1]=="function"&&t[1](e)}),[JSON.stringify(e)]),t},J=n.createContext({}),H=()=>n.useContext(J);function Q(e){if(!e||!("inputs"in e))return e;const{inputs:n,...t}=e;return typeof n=="object"&&"granularity"in n?{...t,inputs:{granularity:n.granularity}}:t}const Y=e=>({...e,dimensions:Array.isArray(e.dimensions)?e.dimensions.map(Q):e.dimensions,measures:Array.isArray(e.measures)?e.measures.map(Q):e.measures,select:Array.isArray(e.select)?e.select.map((e=>Array.isArray(e)?e.map(Q):Q(e))):e.select,orderBy:Array.isArray(e.orderBy)?e.orderBy.map((e=>({...e,property:Q(e.property)}))):e.orderBy,filters:Array.isArray(e.filters)?e.filters.map((e=>({...e,property:Q(e.property)}))):e.filters}),z="embeddable-event:update-client-context",K="embeddable-event:update-props",W="embeddable-event:reload-dataset",X="embeddable-event:load-data-result",Z="embeddable-event:update-theme",ee={loading:"loading",error:"error",data:"data"},ne=(e,n)=>{var t;switch(n.type){case ee.loading:return{...e,[n.inputName]:{data:(t=e[n.inputName])==null?void 0:t.data,isLoading:true}};case ee.data:return{...e,[n.inputName]:{isLoading:false,data:n.payload}};case ee.error:return{...e,[n.inputName]:{isLoading:false,error:n.payload.message||n.payload}}}return e},te=e=>Object.keys(e).reduce(((e,n)=>({...e,[n]:{isLoading:true}})),{}),oe=(e,n)=>Object.fromEntries(Object.entries(e).map((([e,t])=>{var o,r,i,a,l;const s=(o=n.inputs)==null?void 0:o.find((n=>n.name===e)),u=typeof(s==null?void 0:s.type)=="string"?(i=(r=Object.values(V).find((e=>e.toString()===(s==null?void 0:s.type))))==null?void 0:r.typeConfig)==null?void 0:i.transform:(l=(a=s==null?void 0:s.type)==null?void 0:a.typeConfig)==null?void 0:l.transform;return[e,(u==null?void 0:u(t))??t]}))),re=e=>{let n={};return(e.inputs||[]).forEach((e=>{n={...n,[e.name]:e.defaultValue??null}})),n};function ie(n,t,o={}){function r({propsUpdateListener:r,clientContext:i,embeddableTheme:a,...l}){const[s,u]=e.useState(l),[d,m]=e.useState(i),c=e.useState(),[p,f]=e.useState(a??{}),{componentId:v}=l,b=`${X}:${v}`,y=({detail:e})=>u(e),g=({detail:e})=>m(e),w=({detail:e})=>f(e);e.useEffect((()=>{const e=({detail:e})=>{var n;(n=window.__EMBEDDABLE_DEVTOOLS__)==null||n.notifyPropsUpdated(v,t,s,e)};return r.addEventListener(K,e),()=>r.removeEventListener(K,e)}),[s]),e.useEffect((()=>{r.addEventListener(z,g),r.addEventListener(K,y),r.addEventListener(Z,w);const e=new CustomEvent("embeddable-event:update-props-listen",{detail:{componentId:v}});window.dispatchEvent(e);const n=new CustomEvent("embeddable-event:update-client-context-listen",{detail:{componentId:v}});return window.dispatchEvent(n),()=>{r.removeEventListener(z,g),r.removeEventListener(K,y)}}),[]);const{extendedProps:D,dataLoaders:O}=e.useMemo((()=>{var e;return Object.entries({...re(t),...(e=o==null?void 0:o.props)==null?void 0:e.call(o,oe(s,t),c,d)}).reduce(((e,[n,t])=>(_(t)?e.dataLoaders[n]=t:e.extendedProps[n]=t,e)),{extendedProps:{},dataLoaders:{}})}),[s,o==null?void 0:o.props,c[0],d]),[j,L]=e.useReducer(ne,O,te),T=(e,n)=>L({type:ee.data,inputName:e,payload:n}),A=(e,n)=>L({type:ee.error,inputName:e,payload:n}),$=(e,n)=>{L({type:ee.loading,inputName:e});const t=n.dataLoader(r,n.requestParams,v,e);t&&A(e,t)},x=e=>{var n;(n=window.__EMBEDDABLE_DEVTOOLS__)==null||n.notifyDataLoaded(v,t,e.detail),e.detail.isSuccess?T(e.detail.propertyName,e.detail.data):A(e.detail.propertyName,e.detail.error)},N=({detail:e})=>{var n;const o=Object.entries(O).filter((([n,t])=>t.requestParams.from.datasetId===e.datasetId));(n=window.__EMBEDDABLE_DEVTOOLS__)==null||n.notifyVariableUpdated(v,t,e,Object.fromEntries(o)),o.forEach((([e,n])=>$(e,n)))};e.useEffect((()=>(Object.entries(O).forEach((([e,n])=>$(e,n))),window.addEventListener(W,N),r.addEventListener(b,x),()=>{window.removeEventListener(W,N),r.removeEventListener(b,x)})),[JSON.stringify(Object.values(O).map((e=>Y(e.requestParams))))]);const F=(e,n)=>I(r,e,v,n),h=o==null?void 0:o.events,B={};if(h){for(const e in h)if(h.hasOwnProperty(e)){let n=h[e];B[e]=t=>F(n(t),e)}}return e.createElement(k.Provider,{value:c},e.createElement(J.Provider,{value:p},e.createElement(n,{...D,...B,...j})))}return r.displayName=`embedded(${n.displayName??t.name})`,r}export{ie as G,G as H,j as P,N as U,H as k};
//# sourceMappingURL=p-C7Q3h1tE.js.map